---
- name: Installation de Borg
  ansible.builtin.package:
    name: borgbackup
    state: present

- name: Création du dossier d'install de Borgmatic
  ansible.builtin.file:
    path: /opt/borgmatic
    state: directory
    owner: root
    group: root
    mode: u=rwx,go=rx

- name: Installation des dépendances python
  ansible.builtin.package:
    name:
      - python3-venv
      - python3-llfuse
    state: present

- name: Installation de Borgmatic  # noqa package-latest
  ansible.builtin.pip:
    name: borgmatic
    state: present
    version: "{{ borgmatic_version }}"
    virtualenv: /opt/borgmatic
    virtualenv_python: python3
    chdir: /opt/borgmatic

- name: Création du lien symbolique pour le binaire borgmatic
  ansible.builtin.file:
    src: /opt/borgmatic/bin/borgmatic
    dest: /usr/local/bin/borgmatic
    state: link

- name: Création du dossier pour le client SSH
  ansible.builtin.file:
    path: /root/.ssh
    state: directory
    owner: root
    group: root
    mode: u=rwx,go=

- name: Configuration des repos Borg
  ansible.builtin.include_tasks:
    file: repo.yml
  loop: "{{ borgmatic_repositories }}"
  loop_control:
    loop_var: repo
    label: "{{ repo.host }}"

- name: Création du dossier de config de Borgmatic
  ansible.builtin.file:
    path: "/etc/borgmatic.d"
    state: directory
    owner: root
    group: root
    mode: u=rwx,g=rx,o=

- name: Suppression de l'ancien dossier de template de Borgmatic
  ansible.builtin.file:
    path: "/etc/borgmatic"
    state: absent

- name: Configuration commune des backups Borgmatic
  ansible.builtin.template:
    src: borgmatic/common.yml.j2
    dest: /etc/borgmatic.d/common.yml
    owner: root
    group: root
    mode: u=rw,go=
    validate: borgmatic config validate --show -c %s
  notify: Init borgmatic

- name: Création d'un timer pour créer et vérifier les backups périodiquement
  ansible.builtin.copy:
    src: systemd/{{ systemd_unit }}
    dest: /etc/systemd/system/{{ systemd_unit }}
    owner: root
    group: root
    mode: u=rw,go=r
  loop:
    - borgmatic.timer
    - borgmatic.service
    - borgmatic-check.timer
    - borgmatic-check.service
  loop_control:
    loop_var: systemd_unit
  notify: Reload systemd

- name: Activation du timer borgmatic
  ansible.builtin.service:
    name: "{{ systemd_unit }}.timer"
    state: started
    enabled: true
  loop:
    - borgmatic
    - borgmatic-check
  loop_control:
    loop_var: systemd_unit
