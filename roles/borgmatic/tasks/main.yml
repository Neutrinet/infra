---
- name: Installation de Borg
  package:
    name: borgbackup
    state: present

- name: Création du dossier d'install de Borgmatic
  file:
    path: /opt/borgmatic
    state: directory
    owner: root
    group: root
    mode: u=rwx,go=rx

- name: Installation des dépendances python
  ansible.builtin.package:
    name:
      - python3-virtualenv
      - virtualenv
    state: present

- name: Installation de Borgmatic  # noqa package-latest
  pip:
    name: borgmatic
    state: latest
    virtualenv: /opt/borgmatic
    virtualenv_python: python3
    chdir: /opt/borgmatic

- name: Création du dossier pour le client SSH
  file:
    path: /root/.ssh
    state: directory
    owner: root
    group: root
    mode: u=rwx,go=

- name: Configuration des repos Borg
  include_tasks:
    file: repo.yml
  loop: "{{ borgmatic_repositories }}"
  loop_control:
    loop_var: repo
    label: "{{ repo.host }}"

- name: Création des dossiers de config de Borgmatic
  file:
    path: "{{ config_dir }}"
    state: directory
    owner: root
    group: root
    mode: u=rwx,g=rx,o=
  loop:
    - /etc/borgmatic
    - /etc/borgmatic.d
  loop_control:
    loop_var: config_dir

- name: Configuration du template des backups Borgmatic
  template:
    src: borgmatic/template.yml.j2
    dest: /etc/borgmatic/template.yml
    owner: root
    group: root
    mode: u=rw,go=
    validate: /opt/borgmatic/bin/validate-borgmatic-config -c %s

- name: Configuration commune des backups Borgmatic
  template:
    src: borgmatic/common.yml.j2
    dest: /etc/borgmatic.d/common.yml
    owner: root
    group: root
    mode: u=rw,go=
    validate: /opt/borgmatic/bin/validate-borgmatic-config -c %s
  notify: init borgmatic

- name: Création d'un cron job pour créer un backup chaque jour
  cron:
    name: borgmatic-create
    cron_file: borgmatic
    state: present
    minute: 0
    hour: 3
    user: root
    job: sleep $((RANDOM \% 3600)) && borgmatic create prune

- name: Création d'un cron job pour vérifier les backups chaque semaine
  cron:
    name: borgmatic-check
    cron_file: borgmatic
    state: present
    minute: 0
    hour: 2
    weekday: 0
    user: root
    job: borgmatic check

- name: Définition de la variable d'environnement SHELL pour les cron jobs
  cron:
    name: SHELL
    cron_file: borgmatic
    state: present
    user: root
    env: true
    value: /bin/bash
