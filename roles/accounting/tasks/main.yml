---
# Install the accounting Rails app

- name: Install a required packages
  apt:
    name: "{{ packages }}"
    state: present
  vars:
    packages:
    - git
    - libpq-dev

- name: Download Rails app
  git:
    repo: https://github.com/neutrinet/accounting.git
    dest: /var/www/accounting.neutrinet.be/accounting
    force: yes

- name: Update permission
  file:
    path: /var/www/accounting.neutrinet.be/accounting
    recurse: true
    owner: accounting-neutrinet-be
    group: accounting-neutrinet-be

- name: Install bundle
  command: bash -lc "bundle install"
  args:
    chdir: /var/www/accounting.neutrinet.be/accounting

- name: Create database
  become_user: postgres
  postgresql_db:
    name: accounting
    encoding: 'UTF-8'

- name: Create database user
  become_user: postgres
  postgresql_user:
    db: accounting
    name: accounting
    password: "TODO-PWD"
