- name: Cr√©ation du dossier de config systemd pour telegraf.service
  file:
    path: /etc/systemd/system/telegraf.service.d/
    owner: root
    group: root
    mode: "u=rwx,go=rx"
    state: directory

- name: Configuration des permissions pour telegraf.service
  copy:
    src: telegraf.service/override.conf
    dest: /etc/systemd/system/telegraf.service.d/override.conf
    owner: root
    group: root
    mode: "u=rw,go=r"
  notify:
    - reload systemd
    - restart telegraf

- name: Installation des plugins Telegraf
  template:
    src: telegraf/probe.conf.j2
    dest: /etc/telegraf/telegraf.d/probe.conf
    owner: telegraf
    group: telegraf
    mode: "u=rw,g=r,o="
    validate: telegraf --config %s --test
  notify: restart telegraf
  tags: ['telegraf_config']
