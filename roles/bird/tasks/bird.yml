---

- name: Installation de bird2
  ansible.builtin.package:
    name: bird2
    state: present
  tags: ['bird_install']

- name: Création des dossiers pour Bird
  ansible.builtin.file:
    path: "{{ bird_dir }}"
    owner: bird
    group: bird
    mode: "u=rwx,g=rx,o="
    state: directory
  loop:
    - /etc/bird
    - /etc/bird/conf.d
    - /etc/bird/peers
    - /etc/bird/peers/upstreams
    - /etc/bird/peers/downstreams
  loop_control:
    loop_var: bird_dir
  tags: ['bird_config']

- name: Copie des filtre par default
  ansible.builtin.copy:
    src: "bird/conf.d/{{ bird_conf }}"
    dest: "/etc/bird/conf.d/{{ bird_conf }}"
    owner: bird
    group: bird
    mode: "ug=r,o="
  loop:
    - 00_bgp_filter_v4.conf
    - 00_bgp_filter_v6.conf
    - 00_bgp_filter.conf
    - 00_bgp_match_v4.conf
    - 00_bgp_match_v6.conf
    - 05_bgp_community_calcul.conf
    - 10_device.conf
    - 10_direct.conf
    - 10_static.conf
    - 20_bgp_rpki.conf
  loop_control:
    loop_var: bird_conf
  tags: ['bird_config']

- name: Configuration de base de bird
  ansible.builtin.template:
    src: bird/bird.conf.j2
    dest: /etc/bird/bird.conf
    owner: bird
    group: bird
    mode: "ug=r,o="
  notify: restart bird
  tags: ['bird_config']

- name: Configuration des peers upstream de bird
  ansible.builtin.template:
    src: "bird/{{ bird_role }}/upstream.conf.j2"
    dest: "/etc/bird/peers/upstreams/{{ item.type | replace('-', '_') }}_{{ item.asn }}_{{ item.slug }}.conf"
    owner: bird
    group: bird
    mode: "ug=r,o="
  loop: "{{ bird_peers_upstreams }}"
  notify: reload bird
  tags: ['bird_config']

- name: Configuration des peers downstream de bird
  ansible.builtin.template:
    src: "bird/{{ bird_role }}/downstream.conf.j2"
    dest: "/etc/bird/peers/downstreams/{{ item.type | replace('-', '_') }}_{{ item.asn }}_{{ item.slug }}.conf"
    owner: bird
    group: bird
    mode: "ug=r,o="
  loop: "{{ bird_peers_downstreams }}"
  notify: reload bird
  tags: ['bird_config']

- name: Configuration des l'export dans le kernel
  ansible.builtin.template:
    src: "bird/kernel.conf.j2"
    dest: "/etc/bird/conf.d/90_kernel.conf"
    owner: bird
    group: bird
    mode: "ug=r,o="
  notify: reload bird
  when: bird_role != 'route-reflector'
  tags: ['bird_config']

- name: Configuration des route static pour bird
  ansible.builtin.template:
    src: "bird/static-route.conf.j2"
    dest: "/etc/bird/conf.d/10_static_{{ ansible_fqdn | replace('.', '_') | replace('-', '_') }}.conf"
    owner: bird
    group: bird
    mode: "ug=r,o="
  notify: reload bird
  tags: ['bird_config']

- name: Activation du service bird au démarage
  ansible.builtin.service:
    name: bird
    state: started
    enabled: true
  tags: ['bird_config']
