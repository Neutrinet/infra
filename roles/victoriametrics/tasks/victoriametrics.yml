- name: Création des dossiers de VictoriaMetrics
  ansible.builtin.file:
    path: "{{ victoriametrics_dir }}"
    owner: victoriametrics
    group: victoriametrics
    mode: "u=rwx,g=rx,o="
    state: directory
  loop:
    - /opt/victoriametrics
    - /opt/victoriametrics/{{ victoriametrics_version }}
    - /etc/victoriametrics
    - "{{ victoriametrics_storage_path }}"
  loop_control:
    loop_var: victoriametrics_dir

- name: Création du dossier des archives VictoriaMetrics
  ansible.builtin.file:
    path: /usr/local/src/victoriametrics
    owner: root
    group: root
    mode: "u=rwx,g=rx,o="
    state: directory

- name: Téléchargement de l'archive VictoriaMetrics v{{ victoriametrics_version }}
  ansible.builtin.get_url:
    url: https://github.com/VictoriaMetrics/VictoriaMetrics/releases/download/v{{ victoriametrics_version }}/victoria-metrics-linux-amd64-v{{ victoriametrics_version }}.tar.gz
    dest: /usr/local/src/victoriametrics/{{ victoriametrics_version }}.tar.gz
    owner: root
    group: root
    mode: "u=rw,go=r"

- name: Téléchargement de l'archive des outils de VictoriaMetrics v{{ victoriametrics_version }}
  ansible.builtin.get_url:
    url: https://github.com/VictoriaMetrics/VictoriaMetrics/releases/download/v{{ victoriametrics_version }}/vmutils-linux-amd64-v{{ victoriametrics_version }}.tar.gz
    dest: /usr/local/src/victoriametrics/tools-{{ victoriametrics_version }}.tar.gz
    owner: root
    group: root
    mode: "u=rw,go=r"

- name: Décompression de l'archive VictoriaMetrics
  ansible.builtin.unarchive:
    src: /usr/local/src/victoriametrics/{{ victoriametrics_version }}.tar.gz
    dest: /opt/victoriametrics/{{ victoriametrics_version }}
    creates: /opt/victoriametrics/{{ victoriametrics_version }}/victoria-metrics-prod
    remote_src: true
    owner: victoriametrics
    group: victoriametrics

- name: Décompression de l'archive des outils de VictoriaMetrics
  ansible.builtin.unarchive:
    src: /usr/local/src/victoriametrics/tools-{{ victoriametrics_version }}.tar.gz
    dest: /opt/victoriametrics/{{ victoriametrics_version }}
    creates: /opt/victoriametrics/{{ victoriametrics_version }}/vmalert-prod
    remote_src: true
    owner: victoriametrics
    group: victoriametrics

- name: Création du lien symbolique pour les binaires de VictoriaMetrics
  ansible.builtin.file:
    src: /opt/victoriametrics/{{ victoriametrics_version }}/{{ victoriametrics_bin }}
    dest: /usr/local/bin/{{ victoriametrics_bin | replace('-prod', '') }}
    state: link
  loop:
    - victoria-metrics-prod
    - vmagent-prod
    - vmalert-prod
    - vmauth-prod
    - vmbackup-prod
    - vmctl-prod
    - vmrestore-prod
  loop_control:
    loop_var: victoriametrics_bin
  notify: Restart victoriametrics

- name: Configuration de VictoriaMetrics
  ansible.builtin.template:
    src: victoriametrics/victoriametrics.yml.j2
    dest: /etc/victoriametrics/victoriametrics.yml
    owner: victoriametrics
    group: victoriametrics
    mode: "u=rw,g=r,o="
    validate: victoria-metrics -dryRun -promscrape.config=%s
  notify: Reload victoriametrics

- name: Création du répertoire des jobs
  ansible.builtin.file:
    path: /etc/victoriametrics/conf.d
    owner: victoriametrics
    group: victoriametrics
    mode: "u=rwx,go=rx"
    state: directory

- name: Création du répertoire des rules alert
  ansible.builtin.file:
    path: /etc/victoriametrics/rules.d
    owner: victoriametrics
    group: victoriametrics
    mode: "u=rwx,go=rx"
    state: directory

- name: Configuration du service systemd
  ansible.builtin.template:
    src: systemd/victoriametrics.service.j2
    dest: /etc/systemd/system/victoriametrics.service
    owner: root
    group: root
    mode: "u=rw,go=r"
  notify:
    - Restart victoriametrics

- name: Activation de victoriametrics au démarrage
  ansible.builtin.service:
    name: victoriametrics
    state: started
    enabled: true
