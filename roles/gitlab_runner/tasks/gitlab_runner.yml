- name: Ajout de la clé GPG de Gitlab Runner dans APT
  ansible.builtin.get_url:
    url: https://packages.gitlab.com/runner/gitlab-runner/gpgkey
    dest: /etc/apt/keyrings/gitlab-runner.asc
    owner: root
    group: root
    mode: "ugo=r"
    force: true

- name: Ajout du dépôt APT pour Gitlab Runner
  ansible.builtin.apt_repository:
    repo: deb [signed-by=/etc/apt/keyrings/gitlab-runner.asc] https://packages.gitlab.com/runner/gitlab-runner/debian/ {{ ansible_distribution_release | lower }} main
    filename: gitlab-runner
    state: present

- name: Installation de Gitlab Runner
  ansible.builtin.package:
    name: gitlab-runner
    state: present

- name: Configuration de Gitlab Runner
  ansible.builtin.template:
    src: gitlab-runner/config.toml.j2
    dest: /etc/gitlab-runner/config.toml
    owner: root
    group: root
    mode: "u=rw,go="
  notify: Restart gitlab-runner
  tags: ['gitlab_runner_config']

- name: Activation de Gitlab Runner au démarrage
  ansible.builtin.service:
    name: gitlab-runner
    state: started
    enabled: true

- name: Trigger handlers
  # We need to restart gitlab-runner to apply the new config
  # and expose the metrics for telegraf
  ansible.builtin.meta: flush_handlers

- name: Installation des plugins Telegraf
  ansible.builtin.template:
    src: telegraf/gitlab-runner.conf.j2
    dest: /etc/telegraf/telegraf.d/gitlab-runner.conf
    owner: telegraf
    group: telegraf
    mode: "u=rw,g=r,o="
    validate: telegraf --config %s --test
  notify: Restart telegraf
  tags: ['telegraf_config']

- name: Configuration des backups Borgmatic
  ansible.builtin.template:
    src: borgmatic/gitlab-runner.yml.j2
    dest: /etc/borgmatic.d/gitlab-runner.yml
    owner: root
    group: root
    mode: "u=rw,go="
    validate: borgmatic config validate --show -c %s
  tags: ['borgmatic_config']
