- name: Ajout de la clé GPG de Gitlab Runner dans APT
  apt_key:
    url: https://packages.gitlab.com/runner/gitlab-runner/gpgkey
    state: present

- name: Ajout du dépôt APT Gitlab Runner
  apt_repository:
    repo: deb https://packages.gitlab.com/runner/gitlab-runner/debian/ {{ ansible_distribution_release | lower }} main
    filename: gitlab-runner
    state: present

- name: Installation de Gitlab Runner
  package:
    name: gitlab-runner
    state: present

- name: Installation des dépendances python
  package:
    name: python3-gitlab
    state: present

- name: Enregistrement auprès de l'instance Gitlab {{ gitlab_runner_api_url }}
  gitlab_runner:
    name: "{{ inventory_hostname }}"
    api_url: "{{ gitlab_runner_api_url }}"
    api_token: "{{ gitlab_runner_api_token }}"
    registration_token: "{{ gitlab_runner_registration_token }}"
    state: present
    owned: true
    active: true
    access_level: not_protected
  register: _gitlab_runner_registered
  tags: ['gitlab_runner_register']

- name: Sauvegarde du token de Gitlab runner
  import_tasks: token/write.yml
  when: _gitlab_runner_registered.runner.token is defined
  tags: ['gitlab_runner_register']

- name: Lecture du token de Gitlab runner
  import_tasks: token/read.yml
  when: _gitlab_runner_registered.runner.token is not defined
  tags: ['gitlab_runner_register']

- name: Configuration de Gitlab Runner
  template:
    src: gitlab-runner/config.toml.j2
    dest: /etc/gitlab-runner/config.toml
    owner: root
    group: root
    mode: "u=rw,go="
  notify: restart gitlab-runner
  tags: ['gitlab_runner_register']

- name: Activation de Gitlab Runner au démarrage
  service:
    name: gitlab-runner
    state: started
    enabled: true

- name: Installation des plugins Telegraf
  template:
    src: telegraf/gitlab-runner.conf.j2
    dest: /etc/telegraf/telegraf.d/gitlab-runner.conf
    owner: telegraf
    group: telegraf
    mode: "u=rw,g=r,o="
    validate: telegraf --config %s --test
  notify: restart telegraf
  tags: ['telegraf_config']
