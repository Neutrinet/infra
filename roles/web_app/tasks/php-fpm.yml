- name: Copie de la configuration php-fpm
  ansible.builtin.template:
    src: php-fpm/php-pool.conf.j2
    dest: "{{ php_fpm_pool_dir }}/{{ web_app_owner }}.conf"
    owner: root
    group: root
    mode: "u=rw,go=r"
  notify:
    - reload php-fpm
  tags: ['php_config']

- name: Cr√©ation du dossier tmp pour php-fpm
  ansible.builtin.file:
    path: "{{ php_fpm_tmp_dir }}"
    owner: "{{ web_app_owner }}"
    group: "{{ web_app_owner }}"
    mode: "u=rwx,g=rx,o="
    state: directory

- name: Trigger php-fpm handlers
  ansible.builtin.meta: flush_handlers

- name: Installation des plugins Telegraf
  ansible.builtin.template:
    src: telegraf/php-fpm.conf.j2
    dest: /etc/telegraf/telegraf.d/{{ web_app_owner }}.conf
    owner: telegraf
    group: telegraf
    mode: "u=rw,g=r,o="
    validate: telegraf --config %s --test
  notify: restart telegraf
  tags: ['telegraf_config']

- name: Ajout de l'utilisateur telegraf au groupe caddy
  ansible.builtin.user:
    name: telegraf
    groups: caddy
    append: true
  notify: restart telegraf
  tags: ['telegraf_config']
