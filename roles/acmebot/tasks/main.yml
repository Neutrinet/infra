---

- name: Instalation des d√©pendance
  ansible.builtin.package:
    name:
    - python3-dev
    - python3-virtualenv
    state: present

- name: "clone repos"
  git:
    repo: 'https://github.com/plinss/acmebot'
    dest: /opt/acmebot
    version: master
    update: yes

- name: Install pip
  pip:
    requirements: /opt/acmebot/requirements.txt
    virtualenv: /opt/acmebot/.env
    virtualenv_python: python3
    state: present
    chdir: /opt/acmebot

- name: Creates a cron file under /etc/cron.d
  cron:
    name: "acmebot-update"
    cron_file: acmebot-update
    special_time: daily
    user: "root"
    job: "/opt/acmebot/.env/bin/python /opt/acmebot/acmebot --accept --randomwait --quiet"

- name: create dir
  file:
    path: "{{ item }}"
    owner: root
    group: root
    mode: "u+rwx,g+rx,o+rx"
    state: directory
  with_items:
    - /etc/acmebot

- name: Copy conf
  copy: 
    src: "{{ ansible_fqdn | replace('.', '-') }}.json"
    dest: /etc/acmebot/acmebot.json
    owner: root
    group: root
    mode: "u=rw,go=r"
  notify: acmebot update