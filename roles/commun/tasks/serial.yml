---

- name: Enable serial ttyS{{ serial_number  }}
  lineinfile:
    path: "/etc/default/grub"
    regexp: 'GRUB_CMDLINE_LINUX_DEFAULT="(.*)"'
    line: 'GRUB_CMDLINE_LINUX_DEFAULT="console=ttyS{{ serial_number  }},115200n8 console=tty0 quiet"'
  notify: update grub

- name: Clean option grub
  lineinfile:
    path: "/etc/default/grub"
    regexp: 'GRUB_CMDLINE_LINUX="(.*)"'
    line: 'GRUB_CMDLINE_LINUX=""'
  notify: update grub

- name: Enable serial and console input grub
  lineinfile:
    path: "/etc/default/grub"
    line: 'GRUB_TERMINAL_INPUT="console serial"'
    mode: "u=rw,go=r"
    create: true
  notify: update grub

- name: Enable serial and console output grub
  lineinfile:
    path: "/etc/default/grub"
    line: 'GRUB_TERMINAL_OUTPUT="gfxterm serial"'
    mode: "u=rw,go=r"
    create: true
  notify: update grub

- name: Config serial speed in grub
  lineinfile:
    path: "/etc/default/grub"
    line: 'GRUB_SERIAL_COMMAND="serial --speed=115200 --unit={{ serial_number  }} --word=8 --parity=no --stop=1"'
    mode: "u=rw,go=r"
    create: true
  notify: update grub

- name: Trigger Grub handlers
  meta: flush_handlers
