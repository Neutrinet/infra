---
- name: Désinstallation de ntp et timesyncd
  # See https://github.com/ilri/rmg-ansible-public/issues/46
  ansible.builtin.package:
    name:
      - ntp
      - systemd-timesyncd
    state: absent

- name: Installation de chrony
  ansible.builtin.package:
    name: chrony
    state: present

- name: Création de la configuration de chrony
  ansible.builtin.template:
    src: ntp/chrony.conf.j2
    dest: /etc/chrony/chrony.conf
    owner: root
    group: root
    mode: "ugo=r"
  notify: Restart chrony

- name: Création du dossier client pour chrony
  ansible.builtin.file:
    path: /etc/chrony/sources.d/
    state: directory
    mode: "u=rwX,go=rX"
    owner: root
    group: root

- name: Configuration du client NTP pour chrony
  ansible.builtin.template:
    src: ntp/clients.sources.j2
    dest: /etc/chrony/sources.d/clients.sources
    owner: root
    group: root
    mode: "ugo=r"
  notify: Restart chrony

- name: Activation de chrony au démarrage
  ansible.builtin.service:
    name: chrony
    state: started
    enabled: true
