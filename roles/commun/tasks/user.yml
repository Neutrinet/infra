---
# Ajout d'un utilisateur et de ses clés SSH
- name: Ajout de l'utilisateur {{ user.name }}
  ansible.builtin.user:
    name: "{{ user.name }}"
    shell: "{{ user.shell | default('/bin/bash') }}"
    # See https://unix.stackexchange.com/questions/193066/how-to-unlock-account-for-public-key-ssh-authorization-but-not-for-password-aut/193131#193131
    password: '*'
    groups:
      - sudo
      - users
    append: true
    state: "{{ user.state }}"
    update_password: on_create
  tags: ['skip_ansible_lint']

- name: Ajout des clés SSH pour l'utilisateur {{ user.name }}
  ansible.posix.authorized_key:
    user: "{{ user.name }}"
    state: present
    # we can pass multiple keys, but they must be separated by newlines
    key: "{{ user['keys'] | join('\n') }}"
    # remove obsolete keys
    exclusive: true
  when: user.state == 'present'

- name: Suppression du dossier SSH de l'utilisateur {{ user.name }}
  ansible.builtin.file:
    path: "/home/{{ user.name }}/.ssh"
    state: absent
  when: user.state == 'absent'
