---
# Configuration des dépôts et des mises à jour automatiques
- name: Copie des fichiers de dépôts
  copy:
    src: "{{ ansible_distribution_release }}/{{ repo }}"
    dest: /etc/apt/{{ repo }}
    owner: root
    group: root
    mode: "u+rw,go+r"
  loop:
  - sources.list
  - source-security.list
  loop_control:
    loop_var: repo

- name: Mise à jour des serveurs
  apt:
    upgrade: safe
    update_cache: yes

- name: Installation de cron-apt
  apt:
    name: cron-apt
    state: present
    cache_valid_time: "3600"

- name: Copie des fichiers de configuration cron-apt
  template:
    src: config.j2
    dest: /etc/cron-apt/config
    owner: root
    group: root
    mode: "u+rw,go+r"

- name: Installation automatique des mises à jour de sécurité
  replace:
    dest: /etc/cron-apt/action.d/3-download
    regexp: "^dist-upgrade -d -y -o APT::Get::Show-Upgraded=true$"
    replace: "dist-upgrade -y -o APT::Get::Show-Upgraded=true"
    backup: no