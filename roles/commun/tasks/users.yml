---
# Ajout des utilisateurs et de leurs clés SSH
- name: Suppression du mot de passe pour sudo
  ansible.builtin.lineinfile:
    path: /etc/sudoers
    state: present
    regexp: '^%sudo'
    line: '%sudo ALL=(ALL) NOPASSWD: ALL'
    validate: 'visudo -cf %s'
  tags: ['sudo']

- name: Ajout des utilisateurs et de leurs clés SSH
  ansible.builtin.include_tasks: user.yml
  loop: "{{ users }}"
  loop_control:
    loop_var: user
    label: "{{ user.name }} ({{ user.state }})"

- name: Suppression du mot de passe root
  ansible.builtin.user:
    name: root
    state: present
    shell: /bin/bash
    password: '*'
  when: root_password == ''

- name: Configuration du mot de passe root # noqa jinja[invalid]
  ansible.builtin.user:
    name: root
    state: present
    shell: /bin/bash
    password: "{{ root_password | password_hash('sha512', 65534 | random(seed=inventory_hostname) | string) }}"
  when: root_password != ''
  no_log: true

- name: Vérifier si l'utilisateur vagrant existe
  ansible.builtin.getent:
    database: passwd
    key: vagrant
  failed_when: false
  register: vagrant_user_check

- name: Mets a jours l'user vagrant
  ansible.builtin.user:
    name: vagrant
    shell: /bin/bash
    password: '*'
    groups:
      - sudo
      - users
    append: true
    state: present
    update_password: always
  when: vagrant_user_check.ansible_facts.getent_passwd.vagrant is defined

- name: Trigger SSH handlers
  ansible.builtin.meta: flush_handlers
