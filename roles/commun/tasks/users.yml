---
# Ajout des utilisateurs et de leurs clés SSH
- name: Suppression du mot de passe pour sudo
  lineinfile:
    path: /etc/sudoers
    state: present
    regexp: '^%sudo'
    line: '%sudo ALL=(ALL) NOPASSWD: ALL'
    validate: 'visudo -cf %s'
  tags: ['sudo']

- name: Update root
  user:
    name: root
    shell: /bin/bash
    state: present

- name: test si l'hote est un proxmox
  stat:
    path: /etc/pve
  register: pve_dirs

- name: supprission du mots de pass root
  user:
    name: root
    password: '*'
  when: not pve_dirs.stat.exists
  no_log: true

- name: Ajout des utilisateurs et de leurs clés SSH
  include_tasks: user.yml
  loop: "{{ users }}"
  loop_control:
    loop_var: user

- name: Trigger SSH handlers
  meta: flush_handlers
