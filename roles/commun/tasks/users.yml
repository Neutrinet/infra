---
# Ajout des utilisateurs et de leurs clés SSH
- name: Suppression du mot de passe pour sudo
  lineinfile:
    path: /etc/sudoers
    state: present
    regexp: '^%sudo'
    line: '%sudo ALL=(ALL) NOPASSWD: ALL'
    validate: 'visudo -cf %s'
  tags: ['sudo']

- name: Ajout des utilisateurs et de leurs clés SSH
  include_tasks: user.yml
  loop: "{{ users }}"
  loop_control:
    loop_var: user

- name: Test si l'hôte est un Proxmox
  stat:
    path: /etc/pve
  register: _pve_directory

- name: Suppression du mot de passe root
  user:
    name: root
    state: present
    shell: /bin/bash
    password: '*'
  when: not _pve_directory.stat.exists
  tags: ['skip_ansible_lint']

- name: Trigger SSH handlers
  meta: flush_handlers
