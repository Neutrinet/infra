---

- name: Activation du bbr
  ansible.posix.sysctl:
    name: "net.ipv4.tcp_congestion_control"
    value: 'bbr'
    sysctl_file: /etc/sysctl.d/80-bbr.conf
    sysctl_set: true
    state: present
    reload: true

- name: Activation du fq
  ansible.posix.sysctl:
    name: "net.core.default_qdisc"
    value: 'fq'
    sysctl_file: /etc/sysctl.d/80-bbr.conf
    state: absent

- name: Appliquer immédiatement les paramètres sysctl
  ansible.posix.sysctl:
    name: "{{ item.name }}"
    value: "{{ item.value }}"
    sysctl_file: /etc/sysctl.d/80-netlink.conf
    sysctl_set: true
    state: present
    reload: true
  loop:
    - { name: 'net.core.rmem_default', value: '262144' }
    - { name: 'net.core.rmem_max', value: '134217728' }
    - { name: 'net.core.wmem_default', value: '262144' }
    - { name: 'net.core.wmem_max', value: '134217728' }
    - { name: 'net.core.netdev_max_backlog', value: '10000' }
    - { name: 'net.core.netdev_budget', value: '600' }
    - { name: 'net.core.default_qdisc', value: 'fq_codel' }
    - { name: 'net.ipv4.tcp_congestion_control', value: 'bbr' }
    - { name: 'net.ipv4.tcp_rmem', value: '4096 65536 134217728' }
    - { name: 'net.ipv4.tcp_wmem', value: '4096 65536 134217728' }
    - { name: 'net.ipv4.tcp_window_scaling', value: '1' }
    - { name: 'net.ipv4.tcp_timestamps', value: '1' }
