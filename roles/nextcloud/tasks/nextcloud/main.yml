- name: Vérification de la présence du fichier de configuration de Nextcloud
  stat:
    path: "{{ nextcloud_config_file }}"
  register: _nextcloud_config

- name: Installation de Nextcloud {{ nextcloud_version }}
  import_tasks: install.yml
  when: not _nextcloud_config.stat.exists

- name: Copie de la configuration de Nextcloud
  copy:
    content: "{{ nextcloud_config | to_json }}"
    dest: "{{ nextcloud_import_file }}"
    owner: "{{ nextcloud_owner }}"
    group: "{{ nextcloud_group }}"
    mode: "640"
  register: _nextcloud_import

- name: Configuration de Nextcloud
  command: php occ config:import  {{ nextcloud_import_file | quote }}
  args:
    chdir: "{{ nextcloud_install_dir }}"
  become_user: "{{ nextcloud_owner }}"
  when: _nextcloud_import is changed