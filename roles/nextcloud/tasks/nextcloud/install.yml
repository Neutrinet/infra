- name: Création du dossier des sources de Nextcloud {{ nextcloud_version }}
  file:
    path: "{{ nextcloud_src_dir }}"
    state: directory
    owner: "{{ web_app_owner }}"
    group: "{{ web_app_group }}"
    mode: "u=rwx,go=rx"

- name: Téléchargement des sources de Nextcloud {{ nextcloud_version }} et vérification de la signature GPG
  import_role:
    name: gpg_signature
  vars:
    gpg_public_key_url: "{{ nextcloud_gpg_public_key_url }}"
    gpg_checksum_algorithm: "{{ nextcloud_checksum_algorithm }}"
    gpg_verify_url: "{{ nextcloud_install_url }}"
    gpg_verify_dir: "{{ nextcloud_src_dir }}"
    gpg_verify_path: "{{ nextcloud_src_archive }}"
    gpg_verify_owner: "{{ web_app_owner }}"
    gpg_verify_group: "{{ web_app_group }}"
    gpg_verify_mode: "u=rw,go=r"

- name: Création du dossier d'installation de Nextcloud {{ nextcloud_version }}
  file:
    path: "{{ web_app_dist_dir }}"
    state: directory
    owner: "{{ web_app_owner }}"
    group: "{{ web_app_group }}"
    mode: "u=rwx,go=rx"

- name: Décompression de Nextcloud {{ nextcloud_version }}
  unarchive:
    src: "{{ nextcloud_src_archive }}"
    dest: "{{ web_app_dist_dir }}"
    owner: "{{ web_app_owner }}"
    group: "{{ web_app_group }}"
    remote_src: true
    extra_opts: "--strip-components=1"

- name: Création du dossier des données de Nextcloud {{ nextcloud_version }}
  file:
    path: "{{ nextcloud_data_dir }}"
    owner: "{{ web_app_owner }}"
    group: "{{ web_app_group }}"
    mode: "u=rwx,go=rx"
    state: directory

# FIWME Commands should not change things if nothing needs doing
- name: Installation de Nextcloud {{ nextcloud_version }}  # noqa no-changed-when
  command: >-
    {{ php_executable }} occ maintenance:install --no-interaction
      --database pgsql
      --database-name nextcloud
      --database-host localhost
      --database-port 5432
      --database-user {{ nextcloud_database_username | quote }}
      --database-pass {{ nextcloud_database_password | quote }}
      --admin-user {{ nextcloud_admin_username | quote }}
      --admin-pass {{ nextcloud_admin_password | quote }}
      --admin-email {{ nextcloud_admin_email | quote }}
      --data-dir {{ nextcloud_data_dir | quote }}
  args:
    chdir: "{{ web_app_dist_dir }}"
  become_user: "{{ web_app_owner }}"

- import_tasks: status.yml
