{{ ansible_managed | comment }}

http://{{ nextcloud_domain }} {
    root * {{ web_app_dist_dir | to_json }}
    encode gzip
    file_server

    request_body {
        max_size {{ nextcloud_max_upload_size }}
    }

    php_fastcgi unix/{{ php_fpm_socket_file }} {
        env front_controller_active true
{% if nextcloud_trusted_proxies | length > 0 %}
        trusted_proxies {{ nextcloud_trusted_proxies | join(' ') }}
{% endif %}
    }

    redir /.well-known/carddav /remote.php/dav 301
    redir /.well-known/caldav /remote.php/dav 301

    @forbidden {
        path /.htaccess
        path /3rdparty/*
        path /config/*
        path /console.php
        path /db_*
        path /data/*
        path /lib/*
        path /occ
        path /templates/*
        path /README
    }

    respond @forbidden 404

    header {
        # Add headers to serve security related headers
        # Before enabling Strict-Transport-Security headers please read into this
        # topic first.
        # WARNING: Only add the preload option once you read about
        # the consequences in https://hstspreload.org/. This option
        # will add the domain to a hardcoded list that is shipped
        # in all major browsers and getting removed from this list
        # could take several months.
        Strict-Transport-Security            "max-age=15768000; {% if nextcloud_hsts_preload_enabled %}preload;{% endif %}"
    }

    log {
        output file {{ web_app_caddy_log | to_json }}
    }
}
