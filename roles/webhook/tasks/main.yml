---
- name: Installation de webhook
  ansible.builtin.package:
    name: webhook
    state: present

- name: Création du dossier de configuration
  ansible.builtin.file:
    path: /etc/webhook
    state: directory
    owner: "{{ webhook_owner }}"
    group: "{{ webhook_group }}"
    mode: "u=rwx,g=rx,o="

- name: Création du dossier des scripts
  ansible.builtin.file:
    path: /etc/webhook/scripts
    state: directory
    owner: "{{ webhook_owner }}"
    group: "{{ webhook_group }}"
    mode: "u=rwx,go=rx"

- name: Copie du script exécuté par le webhook
  ansible.builtin.copy:
    src: "{{ webhook_script }}"
    dest: /etc/webhook/scripts/{{ webhook_script | basename }}
    owner: "{{ webhook_owner }}"
    group: "{{ webhook_group }}"
    mode: "u=rwx,go=rx"

- name: Configuration du webhook
  ansible.builtin.template:
    src: webhook/config.yml.j2
    dest: /etc/webhook/config.yml
    owner: "{{ webhook_owner }}"
    group: "{{ webhook_group }}"
    mode: "u=rw,g=r,o="
  notify: reload webhook

- name: Configuration du service systemd
  ansible.builtin.template:
    src: systemd/webhook.service.j2
    dest: /etc/systemd/system/webhook.service
    owner: root
    group: root
    mode: "u=rw,go=r"
  notify:
    - reload systemd
    - restart webhook

- name: Configuration des backups Borgmatic
  ansible.builtin.template:
    src: borgmatic/webhook.yml.j2
    dest: /etc/borgmatic.d/webhook.yml
    owner: root
    group: root
    mode: "u=rw,go="
    validate: borgmatic config validate --show -c %s
  tags: ['borgmatic_config']
