- name: Création du dossier de Hedgedoc
  ansible.builtin.file:
    path: /var/www/{{ hedgedoc_owner }}/hedgedoc-{{ hedgedoc_version }}
    owner: "{{ hedgedoc_owner }}"
    group: "{{ hedgedoc_owner }}"
    mode: "u=rwx,g=rx,o="
    state: directory

- name: Téléchargement de Hedgedoc v{{ hedgedoc_version }}
  ansible.builtin.unarchive:
    src: https://github.com/hedgedoc/hedgedoc/releases/download/{{ hedgedoc_version }}/hedgedoc-{{ hedgedoc_version }}.tar.gz
    dest: /var/www/{{ hedgedoc_owner }}/hedgedoc-{{ hedgedoc_version }}
    creates: /var/www/{{ hedgedoc_owner }}/hedgedoc-{{ hedgedoc_version }}/README.md
    remote_src: true
    extra_opts:
      - --strip-components=1
    owner: "{{ hedgedoc_owner }}"
    group: "{{ hedgedoc_owner }}"

- name: Installation des dépendences
  ansible.builtin.package:
    name: make
    state: present

- name: Installation de Hedgedoc
  ansible.builtin.command:
    cmd: npm install --production
    chdir: /var/www/{{ hedgedoc_owner }}/hedgedoc-{{ hedgedoc_version }}
    creates: /var/www/{{ hedgedoc_owner }}/hedgedoc-{{ hedgedoc_version }}/node_modules
  become_user: "{{ hedgedoc_owner }}"

- name: Configuration de Hedgedoc
  ansible.builtin.template:
    src: hedgedoc/config.json.j2
    dest: /var/www/{{ hedgedoc_owner }}/hedgedoc-{{ hedgedoc_version }}/config.json
    owner: "{{ hedgedoc_owner }}"
    group: "{{ hedgedoc_owner }}"
    mode: "u=rw,g=r,o="
  notify: restart hedgedoc

- name: Configuration du service systemd
  ansible.builtin.template:
    src: systemd/hedgedoc.service.j2
    dest: /etc/systemd/system/hedgedoc.service
    owner: root
    group: root
    mode: "u=rw,go=r"
  notify:
    - reload systemd
    - restart hedgedoc

- name: Création du lien symbolique vers la dernière version de Hedgedoc
  ansible.builtin.file:
    src: /var/www/{{ hedgedoc_owner }}/hedgedoc-{{ hedgedoc_version }}
    dest: /var/www/{{ hedgedoc_owner }}/dist
    state: link
  notify: restart hedgedoc

- name: Activation de Hedgedoc au démarrage
  ansible.builtin.service:
    name: hedgedoc
    state: started
    enabled: true

- name: Trigger Hedgedoc handlers
  ansible.builtin.meta: flush_handlers

- name: Vérication que le serveur Hedgedoc est prêt
  ansible.builtin.uri:
    url: http://localhost:3000/status
  register: _hedgedoc_server_status
  retries: 10
  delay: 3
  until: _hedgedoc_server_status is success
