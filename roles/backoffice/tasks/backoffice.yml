- name: Installation de pip2 et ses dépendances
  ansible.builtin.package:
    name:
      - python-pip
      - virtualenv
      - libpq-dev
      - python-dev
      - gcc
    state: present

- name: Récupération du dépôt git de backoffice  # noqa latest[git]
  ansible.builtin.git:
    repo: https://gitlab.domainepublic.net/Neutrinet/backoffice.git
    dest: "{{ web_app_dist_dir }}"
    single_branch: true
  become: true
  become_user: "{{ web_app_owner }}"
  notify: restart backoffice

- name: Configuration de backoffice
  ansible.builtin.template:
    src: backoffice/settings_local.py.j2
    dest: "{{ web_app_dist_dir }}/backoffice/settings_local.py"
    owner: "{{ web_app_owner }}"
    group: "{{ web_app_owner }}"
    mode: "u=rw,g=r,o="
  notify: restart backoffice

- name: Création du virtualenv python
  ansible.builtin.pip:
    requirements: "{{ web_app_dist_dir }}/requirements.txt"
    state: present
    virtualenv: "{{ web_app_dist_dir }}/env"
    virtualenv_python: python2
  become: true
  become_user: "{{ web_app_owner }}"
  notify: restart backoffice

- name: Configuration du service systemd
  ansible.builtin.template:
    src: systemd/backoffice.service.j2
    dest: /etc/systemd/system/backoffice.service
    owner: root
    group: root
    mode: "u=rw,go=r"
  notify:
    - reload systemd
    - restart backoffice

- name: Activation de Backoffice au démarrage
  ansible.builtin.service:
    name: backoffice
    state: started
    enabled: true
