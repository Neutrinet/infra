- name: Installation de pip2 et ses dépendances
  ansible.builtin.package:
    name:
      - virtualenv
      - libpq-dev
      - python2-dev
      - gcc
    state: present

- name: Téléchargement de get-pip2
  ansible.builtin.get_url:
    url: https://bootstrap.pypa.io/pip/2.7/get-pip.py
    dest: /opt/get-pip.py
    owner: root
    group: root
    mode: "u=rwx,go=rx"
  register: download_get_pip2

- name: Exécution de get-pip2  # noqa no-handler
  ansible.builtin.command:
    cmd: python2 /opt/get-pip.py
  changed_when: true
  when: download_get_pip2 is changed

- name: Récupération du dépôt git de backoffice  # noqa latest[git]
  ansible.builtin.git:
    repo: https://gitlab.domainepublic.net/Neutrinet/backoffice.git
    dest: /var/www/{{ backoffice_owner }}/dist
    single_branch: true
  become: true
  become_user: "{{ backoffice_owner }}"
  notify: Restart backoffice

- name: Configuration de backoffice
  ansible.builtin.template:
    src: backoffice/settings_local.py.j2
    dest: /var/www/{{ backoffice_owner }}/dist/backoffice/settings_local.py
    owner: "{{ backoffice_owner }}"
    group: "{{ backoffice_owner }}"
    mode: "u=rw,g=r,o="
  notify: Restart backoffice

- name: Création du virtualenv python
  ansible.builtin.pip:
    requirements: /var/www/{{ backoffice_owner }}/dist/requirements.txt
    state: present
    virtualenv: /var/www/{{ backoffice_owner }}/dist/env
    virtualenv_python: python2
  become: true
  become_user: "{{ backoffice_owner }}"
  notify: Restart backoffice

- name: Configuration du service systemd
  ansible.builtin.template:
    src: systemd/backoffice.service.j2
    dest: /etc/systemd/system/backoffice.service
    owner: root
    group: root
    mode: "u=rw,go=r"
  notify:
    - Reload systemd
    - Restart backoffice

- name: Activation de Backoffice au démarrage
  ansible.builtin.service:
    name: backoffice
    state: started
    enabled: true
