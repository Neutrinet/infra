---

- name: Test si le certificat {{ domain }} ecdsa existe
  ansible.builtin.stat:
    path: /etc/letsencrypt/live/{{ domain | replace('.', '-') }}-ecdsa/cert.pem
  register: letsencrypt_domain_ecdsa

- name: Cr√©ation du certificat {{ domain }} ecdsa  # noqa command-instead-of-shell
  ansible.builtin.shell:
    cmd: |
      /opt/letsencrypt/bin/certbot certonly \
      --non-interactive \
      {% if letsencrypt_staging %}--staging \{% endif %}
      --authenticator dns-gandi \
      --dns-gandi-credentials /etc/letsencrypt/gandi/gandi.ini \
      --key-type ecdsa \
      --cert-name {{ domain | replace('.', '-') }}-ecdsa \
      --domain {{ domain }} \
      --domain *\.{{ domain }} \
      --post-hook 'systemctl restart haproxy' \
      --deploy-hook /etc/letsencrypt/haproxy.py
  when: not letsencrypt_domain_ecdsa.stat.exists
