---

- name: Installation de haproxy
  ansible.builtin.apt:
    name: haproxy
    state: present
    default_release: "{{ ansible_distribution_release }}-backports"

- name: Création du répertoire ssl
  file:
    path: /etc/haproxy/ssl
    mode: "u=rwx,g=rx,o="
    owner: haproxy
    group: haproxy
    state: directory

- name: Copie du certificat par défaut
  copy:
    src: default.pem
    dest: /etc/haproxy/ssl/default.pem
    mode: "u=rw,g=r,o="
    owner: haproxy
    group: haproxy
  notify: reload haproxy

- name: Config de haproxy
  template:
    dest: /etc/haproxy/haproxy.cfg
    src: haproxy.conf.j2
    owner: root
    group: root
    mode: "u=rw,go=r"
    validate: "haproxy -f %s -c -q"
  notify: reload haproxy

- name: Activation de haproxy au démarrage
  service:
    name: haproxy
    state: started
    enabled: true
