---
- name: Installation de rsync
  ansible.builtin.package:
    name: rsync
    state: present

- name: Installation de haproxy
  ansible.builtin.package:
    name: haproxy
    state: present
    default_release: "{{ ansible_distribution_release }}-backports"

- name: Création du répertoire ssl
  ansible.builtin.file:
    path: /etc/haproxy/ssl
    mode: "u=rwx,g=rx,o="
    owner: haproxy
    group: haproxy
    state: directory

- name: Copie du certificat par défaut
  ansible.builtin.copy:
    src: default.pem
    dest: /etc/haproxy/ssl/default.pem
    mode: "u=rw,g=r,o="
    owner: haproxy
    group: haproxy
  notify: reload haproxy

- name: Création du dossier des pages d'erreur personnalisées
  ansible.builtin.file:
    path: /etc/haproxy/errors
    state: directory
    mode: "u=rwx,go=rx"
    owner: haproxy
    group: haproxy

- name: Copie des pages d'erreur personnalisées
  ansible.posix.synchronize:
    src: errors/
    dest: /etc/haproxy/errors/
    mode: push
    archive: false
    recursive: true
    delete: true
  become: true
  become_user: haproxy
  notify: reload haproxy

- name: Config de haproxy
  ansible.builtin.template:
    dest: /etc/haproxy/haproxy.cfg
    src: haproxy.conf.j2
    owner: root
    group: root
    mode: "u=rw,g=r,o="
    validate: "haproxy -f %s -c -q"
  notify: reload haproxy

- name: Activation de haproxy au démarrage
  ansible.builtin.service:
    name: haproxy
    state: started
    enabled: true

- name: Trigger haproxy handler
  # We force haproxy to reload its config to ensure our config has been applied.
  # This forced reload is required on debian systems,
  # because haproxy appears to be already started and enabled by apt,
  # and later in this role, telegraf expects our haproxy to be correctly configured.
  ansible.builtin.meta: flush_handlers
