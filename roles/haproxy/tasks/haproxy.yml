---

- name: Installation de haproxy
  ansible.builtin.apt:
    name: haproxy
    state: present
    default_release: "{{ ansible_distribution_release }}-backports"

- name: Création du répertoire ssl
  file:
    path: "{{ haproxy_ssl_dir }}"
    mode: "u=rwx,go=rx"
    owner: root
    group: root
    state: directory

- name: Copie du certificat par défaut
  copy:
    src: default.pem
    dest: "{{ haproxy_ssl_dir }}/default.pem"
    mode: "u=rw,go=r"
    owner: root
    group: root

- name: Config de haproxy
  template:
    dest: /etc/haproxy/haproxy.cfg
    src: haproxy.conf.j2
    owner: root
    group: root
    mode: "u=rw,go=r"
    validate: "haproxy -f %s -c -q"
  notify: reload haproxy

- name: Activation de haproxy au démarrage
  service:
    name: haproxy
    state: started
    enabled: true
