---

- name: Test si le certificat {{ domain }} rsa existe
  stat:
    path: /etc/letsencrypt/live/{{ domain | replace('.', '-') }}/cert.pem
  register: letsencrypt_domain_rsa

- name: Cr√©ation du certificat {{ domain }} rsa  # noqa command-instead-of-shell
  shell:
    cmd: |
      /opt/letsencrypt/bin/certbot certonly \
      --non-interactive \
      {% if letsencrypt.staging | default(true) %}--staging \{% endif %}
      --authenticator dns-gandi \
      --dns-gandi-credentials /etc/letsencrypt/gandi/gandi.ini \
      --key-type rsa \
      --rsa-key-size 4096 \
      --cert-name {{ domain | replace('.', '-') }} \
      --domain {{ domain }} \
      --domain *\.{{ domain }} \
      --post-hook 'systemctl restart haproxy' \
      --deploy-hook /etc/letsencrypt/haproxy.py
  when: not letsencrypt_domain_rsa.stat.exists
