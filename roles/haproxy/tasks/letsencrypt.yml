---

- name: Instalation des dépendance
  ansible.builtin.package:
    name:
      - python3-dev
      - python3-virtualenv
      - virtualenv
    state: present

- name: "Création des dossier"
  file:
    path: "{{ item }}"
    owner: root
    group: root
    mode: "u=rw,go=r"
    state: directory
  with_items:
    - /etc/letsencrypt
    - /etc/letsencrypt/gandi
    - /opt/letsencrypt

- name: Install pip  # noqa package-latest
  ansible.builtin.pip:
    name:
      - pip
      - certbot
      - certbot-plugin-gandi
    virtualenv: /opt/letsencrypt
    virtualenv_python: python3
    state: latest
    chdir: /opt/letsencrypt

- name: Creates a cron file under /etc/cron.d
  cron:
    name: "letsencrypt-update"
    cron_file: letsencrypt-update
    special_time: daily
    user: "root"
    job: "/opt/letsencrypt/bin/certbot certonly"

- name: Test si le compte LE existe
  stat:
    path: /etc/letsencrypt/accounts
  register: letsencrypt_accounts

- name: Enregistrement du compte LE  # noqa command-instead-of-shell
  shell:
    cmd: |
      /opt/letsencrypt/bin/certbot register \
      --non-interactive \
      {% if letsencrypt.staging | default(true) %}--staging \{% endif %}
      --email {{ mail_notification }} \
      --no-eff-email \
      --agree-tos
  when: not letsencrypt_accounts.stat.exists

- name: placeent du hook pour haproxy
  copy:
    src: haproxy.py
    dest: /etc/letsencrypt/haproxy.py
    mode: "u=rwx,go=rx"
    owner: root
    group: root

- name: Config de gandi pour letsencrypt
  template:
    dest: /etc/letsencrypt/gandi/gandi.ini
    src: gandi.ini.j2
    owner: root
    group: root
    mode: "u=rw,go="

- name: Création des crtificat rsa par challenge gandi
  include_tasks: letsencrypt-gandi-rsa.yml
  loop: "{{ letsencrypt.domains_gandi }}"
  loop_control:
    loop_var: domain
  when: '"domains_gandi" in letsencrypt'

- name: Création des crtificat ecdsa par challenge gandi
  include_tasks: letsencrypt-gandi-ecdsa.yml
  loop: "{{ letsencrypt.domains_gandi }}"
  loop_control:
    loop_var: domain
  when: '"domains_gandi" in letsencrypt'
