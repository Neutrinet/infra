- name: Détection du serveur PostgreSQL primaire
  ansible.builtin.import_tasks: patroni.yml
  when: postgresql_patroni_hosts | length > 0

- name: Ajout de la clé GPG de PostgreSQL
  ansible.builtin.get_url:
    url: https://www.postgresql.org/media/keys/ACCC4CF8.asc
    dest: /etc/apt/keyrings/postgresql.asc
    owner: root
    group: root
    mode: "ugo=r"
    force: true

- name: Suppresion de l'ancien dépôt APT pour PostgreSQL
  ansible.builtin.apt_repository:
    repo: deb http://apt.postgresql.org/pub/repos/apt {{ ansible_distribution_release }}-pgdg main
    filename: postgresql
    state: absent

- name: Ajout du dépôt APT pour PostgreSQL
  ansible.builtin.apt_repository:
    repo: deb [signed-by=/etc/apt/keyrings/postgresql.asc] http://apt.postgresql.org/pub/repos/apt {{ ansible_distribution_release }}-pgdg main
    filename: postgresql
    state: present

- name: Installation des dépendences
  ansible.builtin.package:
    name:
      - postgresql-client-{{ postgresql_major_version }}
      - acl
    state: present

- name: Création de la base de données PostgreSQL {{ postgresql_db_name }}
  community.postgresql.postgresql_db:
    name: "{{ postgresql_db_name }}"
    state: present
  become: true
  become_user: postgres
  delegate_to: "{{ postgresql_patroni_primary_host | default(inventory_hostname) }}"

- name: Création de l'utilisateur PostgreSQL {{ postgresql_db_name }}
  community.postgresql.postgresql_user:
    db: "{{ postgresql_db_name }}"
    name: "{{ postgresql_db_name }}"
    password: "{{ postgresql_db_password }}"
    role_attr_flags: "{{ postgresql_db_role_attributes }}"
  become: true
  become_user: postgres
  delegate_to: "{{ postgresql_patroni_primary_host | default(inventory_hostname) }}"
  no_log: true

- name: Octroi des privilèges à l'utilisateur PostgreSQL {{ postgresql_db_name }}
  community.postgresql.postgresql_privs:
    db: "{{ postgresql_db_name }}"
    priv: ALL
    type: database
    role: "{{ postgresql_db_name }}"
    state: present
  become: true
  become_user: postgres
  delegate_to: "{{ postgresql_patroni_primary_host | default(inventory_hostname) }}"

- name: Changement du propriétaire de la base de données
  community.postgresql.postgresql_db:
    db: "{{ postgresql_db_name }}"
    owner: "{{ postgresql_db_name }}"
    state: present
  become: true
  become_user: postgres
  delegate_to: "{{ postgresql_patroni_primary_host | default(inventory_hostname) }}"
  when: postgresql_db_change_owner
