- name: Détection du serveur PostgreSQL primaire
  uri:
    url: http://localhost:8008/primary
    status_code: [200, 503]
  delegate_to: "{{ host }}"
  loop: "{{ postgresql_cluster_hosts }}"
  loop_control:
    loop_var: host
  register: _postgresql_cluster_primary

- name: Énumération des serveurs PostgreSQL primaires détectés
  set_fact:
    postgresql_cluster_primary_hosts: >-
      {{ _postgresql_cluster_primary.results
        | selectattr("status", "==", 200)
        | map(attribute="host")
        | list }}

- name: Vérification qu'il n'y a qu'un seul serveur PostgreSQL primaire
  assert:
    that: postgresql_cluster_primary_hosts | length == 1
    fail_msg: "Il ne peut y avoir qu'un seul serveur PostgreSQL primaire, trouvé {{ postgresql_cluster_primary_hosts | length }}"

- name: Définition du serveur PostgreSQL primaire
  set_fact:
    postgresql_cluster_primary_host: "{{ postgresql_cluster_primary_hosts | first }}"
    postgresql_db_user_become: ""
