- name: Détection du serveur PostgreSQL primaire
  ansible.builtin.uri:
    url: http://{{ host }}:8008/read-write
    method: HEAD
    status_code: [200, 503]
  loop: "{{ postgresql_patroni_hosts }}"
  loop_control:
    loop_var: host
  register: _postgresql_patroni_read_write

- name: Énumération des serveurs PostgreSQL primaires détectés
  ansible.builtin.set_fact:
    postgresql_patroni_primary_hosts: >-
      {{ _postgresql_patroni_read_write.results
        | selectattr("status", "==", 200)
        | map(attribute="host")
        | list }}

- name: Vérification qu'il n'y a qu'un seul serveur PostgreSQL primaire
  ansible.builtin.assert:
    that: postgresql_patroni_primary_hosts | length == 1
    fail_msg: "Il ne peut y avoir qu'un seul serveur PostgreSQL primaire, trouvé {{ postgresql_patroni_primary_hosts | length }}"

- name: Définition du serveur PostgreSQL primaire
  ansible.builtin.set_fact:
    postgresql_patroni_primary_host: "{{ postgresql_patroni_primary_hosts | first }}"
