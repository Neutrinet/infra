---
- name: Prepare
  hosts: all
  become: true

  pre_tasks:
    - name: Mise à jour du cache APT
      ansible.builtin.apt:
        update_cache: true

    - name: Ajout du domaine dans /etc/hosts
      ansible.builtin.lineinfile:
        path: /etc/hosts
        line: ::1 minio.neutrinet.be s3.neutrinet.be
        state: present

    - name: Téléchargement du Root CA staging de Let's encrypt
      # Minio ne permet pas d'ignorer la vérification du certificat
      # Comme on utilise les certificats de test de Let's encrypt,
      # on doit donc les ajouter dans les CA de confiance
      ansible.builtin.get_url:
        url: https://letsencrypt.org/certs/staging/{{ ca_name }}.pem
        dest: /usr/local/share/ca-certificates/{{ ca_name }}.crt
        mode: "u=rw,go=r"
        owner: root
        group: root
      loop:
        - letsencrypt-stg-root-x1
        - letsencrypt-stg-root-x2
      loop_control:
        loop_var: ca_name
      notify: Update ca certificates

  roles:
    - telegraf
    - borgmatic
    - haproxy
    - minio

  handlers:
    - name: Update ca certificates
      ansible.builtin.command:
        cmd: update-ca-certificates
      changed_when: true
