- name: Installation des dépendances
  ansible.builtin.package:
    name: zip
    state: present

- name: Création des dossiers pour rclone
  ansible.builtin.file:
    path: "{{ rclone_dir }}"
    owner: rclone
    group: rclone
    mode: "u=rwx,g=rx,o="
    state: directory
  loop:
    - /opt/rclone
    - /opt/rclone/{{ rclone_version }}
  loop_control:
    loop_var: rclone_dir

- name: Création du dossier des archives de rclone
  ansible.builtin.file:
    path: /usr/local/src/rclone
    owner: root
    group: root
    mode: "u=rwx,g=rx,o="
    state: directory

- name: Téléchargement de l'archive de rclone v{{ rclone_version }}
  ansible.builtin.get_url:
    url: https://downloads.rclone.org/v{{ rclone_version }}/rclone-v{{ rclone_version }}-linux-amd64.zip
    dest: /usr/local/src/rclone/{{ rclone_version }}.zip
    owner: root
    group: root
    mode: "u=rw,go=r"
    checksum: "sha256:https://downloads.rclone.org/v{{ rclone_version }}/SHA256SUMS"

- name: Décompression de l'archive  # noqa command-instead-of-module
  # Il y a un bug avec l'option -j et le module unarchived sur un fichier zip...
  # Le plus simple est d'utiliser unzip directement
  ansible.builtin.command:
    cmd: unzip -j /usr/local/src/rclone/{{ rclone_version }}.zip -d /opt/rclone/{{ rclone_version }}
    creates: /opt/rclone/{{ rclone_version }}/rclone

- name: Création du lien symbolique pour le binaire rclone
  ansible.builtin.file:
    src: /opt/rclone/{{ rclone_version }}/rclone
    dest: /usr/local/bin/rclone
    state: link

- name: Obfuscation du mot de passe de chiffrement
  ansible.builtin.shell:
    cmd: rclone obscure "{{ rclone_backup_encryption_password }}" > /opt/rclone/.backup_encryption_password.secret
    creates: /opt/rclone/.backup_encryption_password.secret

- name: Permissions pour le mot de passe de chiffrement obfusqué
  ansible.builtin.file:
    path: /opt/rclone/.backup_encryption_password.secret
    state: file
    mode: "u=rw,go="
    owner: root
    group: root

- name: Récupération du mot de passe de chiffrement obfusqué
  ansible.builtin.slurp:
    src: /opt/rclone/.backup_encryption_password.secret
  register: rclone_obscured_encryption_password
  no_log: true

- name: Obfuscation du salt de chiffrement
  ansible.builtin.shell:
    cmd: rclone obscure "{{ rclone_backup_encryption_salt }}" > /opt/rclone/.backup_encryption_salt.secret
    creates: /opt/rclone/.backup_encryption_salt.secret

- name: Permissions pour le salt de chiffrement obfusqué
  ansible.builtin.file:
    path: /opt/rclone/.backup_encryption_salt.secret
    state: file
    mode: "u=rw,go="
    owner: root
    group: root

- name: Récupération du salt de chiffrement obfusqué
  ansible.builtin.slurp:
    src: /opt/rclone/.backup_encryption_salt.secret
  register: rclone_obscured_encryption_salt
  no_log: true

- name: Décodage du salt et du mot de passe de chiffrement obfusqués
  ansible.builtin.set_fact:
    rclone_backup_obscure_encryption_password: "{{ rclone_obscured_encryption_password.content | b64decode | trim }}"
    rclone_backup_obscure_encryption_salt: "{{ rclone_obscured_encryption_salt.content | b64decode | trim }}"
  no_log: true

- name: Configuration de rclone
  ansible.builtin.template:
    src: rclone.conf.j2
    dest: /etc/rclone.conf
    owner: rclone
    group: rclone
    mode: "u=rw,g=r,o="
  no_log: true

- name: Création d'un timer pour créer les backups périodiquement
  ansible.builtin.copy:
    src: systemd/rclone-backup.timer
    dest: /etc/systemd/system/rclone-backup.timer
    owner: root
    group: root
    mode: u=rw,go=r
  notify: Reload systemd

- name: Création d'un service pour créer les backups périodiquement
  ansible.builtin.template:
    src: systemd/rclone-backup.service.j2
    dest: /etc/systemd/system/rclone-backup.service
    owner: root
    group: root
    mode: u=rw,go=r
  notify: Reload systemd

- name: Activation du timer rclone
  ansible.builtin.service:
    name: rclone-backup.timer
    state: started
    enabled: true
