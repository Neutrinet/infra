- name: Cr√©ation de l'utilisateur pour Alertmanager
  ansible.builtin.import_tasks: user.yml
  tags: ['user']

- name: Installation d'Alertmanager
  ansible.builtin.import_tasks: alertmanager.yml
  tags: ['alertmanager']

- name: Nettoyage des anciennes versions
  ansible.builtin.import_tasks: cleanup.yml
  tags: ['cleanup']

- name: Configuration des alertes
  ansible.builtin.import_tasks: rules.yml
  tags: ['rules']

- name: Installation de matrix-alertbot
  ansible.builtin.import_tasks: matrix-alertbot.yml
  tags: ['matrix_alertbot']

- name: Configuration des backups Borgmatic
  ansible.builtin.template:
    src: borgmatic/{{ config }}.yml.j2
    dest: /etc/borgmatic.d/{{ config }}.yml
    owner: root
    group: root
    mode: "u=rw,go="
    validate: borgmatic config validate --show -c %s
  loop:
    - alertmanager
    - matrix-alertbot
  loop_control:
    loop_var: config
  tags: ['borgmatic_config']
