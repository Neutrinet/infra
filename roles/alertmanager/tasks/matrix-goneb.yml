- name: Installation de Go
  import_role:
    name: go
  vars:
    go_version: "1.17.5"
  tags: ['go']

- name: Création du dossier /var/www
  file:
    path: /var/www
    owner: root
    group: root
    mode: "u=rwx,go=rx"
    state: directory

- name: Création de l'utilisateur matrix-goneb
  user:
    name: matrix-goneb
    home: /var/www/matrix-goneb
    shell: /sbin/nologin
    system: true
    state: present

- name: Création des dossiers pour matrix-goneb
  file:
    path: "{{ matrix_goneb_dir }}"
    owner: matrix-goneb
    group: matrix-goneb
    mode: "u=rwx,go=rx"
    state: directory
  loop:
    - /var/www/matrix-goneb/src
    - /var/www/matrix-goneb/dist
    - /var/www/matrix-goneb/dist/db
  loop_control:
    loop_var: matrix_goneb_dir

- name: Récupération du dépôt git de matrix-goneb
  git:
    repo: https://github.com/matrix-org/go-neb.git
    version: master
    dest: /var/www/matrix-goneb/src
    single_branch: true
    update: true
  become_user: matrix-goneb
  register: _alertmanager_matrix_goneb_repo
  notify: restart matrix-goneb

- name: Installation des dépendences de matrix-goneb
  apt:
    name: libolm-dev
    # See https://github.com/matrix-org/go-neb/issues/338#issuecomment-707989819
    default_release: "{{ (ansible_distribution_release == 'buster') | ternary('buster-backports',omit) }}"
    state: present

- name: Compilation de matrix-goneb # noqa no-handler
  command:
    cmd: "go{{ go_version }} build github.com/matrix-org/go-neb"
    chdir: /var/www/matrix-goneb/src
  become_user: matrix-goneb
  when: _alertmanager_matrix_goneb_repo is changed

- name: Création du lien symbolique pour le binaire matrix-goneb
  file:
    src: /var/www/matrix-goneb/src/go-neb
    dest: /usr/local/bin/matrix-goneb
    owner: matrix-goneb
    group: matrix-goneb
    mode: "u=rwx,go=rx"
    state: link

- name: Connexion de l'utilisateur Matrix
  uri:
    url: https://{{ alertmanager_matrix_host }}/_matrix/client/r0/login
    method: POST
    body:
      identifier:
        type: m.id.user
        user: "{{ alertmanager_matrix_username }}"
      password: "{{ alertmanager_matrix_password }}"
      type: m.login.password
    body_format: json
    creates: /var/www/matrix-goneb/matrix-session.secret
    dest: /var/www/matrix-goneb/matrix-session.secret
    owner: matrix-goneb
    group: matrix-goneb
    mode: "u=rw,go="

- name: Récupération des infos de connexion
  slurp:
    src: /var/www/matrix-goneb/matrix-session.secret
  register: _alertmanager_matrix_session_encoded

- name: Définition du token et device de l'utilisateur Matrix
  set_fact:
    alertmanager_matrix_token: "{{ _alertmanager_matrix_session.access_token }}"
    alertmanager_matrix_device: "{{ _alertmanager_matrix_session.device_id }}"
  vars:
    _alertmanager_matrix_session: "{{ _alertmanager_matrix_session_encoded.content | b64decode | from_json }}"

- name: Vérification de la connexion
  uri:
    url: https://{{ alertmanager_matrix_host }}/_matrix/client/r0/devices/{{ alertmanager_matrix_device }}
    headers:
      Authorization: Bearer {{ alertmanager_matrix_token }}

- name: Configuration de matrix-goneb
  template:
    src: matrix-goneb/config.yml.j2
    dest: /var/www/matrix-goneb/dist/config.yml
    owner: matrix-goneb
    group: matrix-goneb
    mode: "u=rw,g=r,o="
  notify: restart matrix-goneb

- name: Configuration du service systemd
  copy:
    src: systemd/matrix-goneb.service
    dest: /etc/systemd/system/matrix-goneb.service
    owner: root
    group: root
    mode: "u=rw,go=r"
  notify:
    - reload systemd
    - restart matrix-goneb

- name: Activation de matrix-goneb au démarrage
  service:
    name: matrix-goneb
    state: started
    enabled: true
