- name: Création de l'utilisateur matterbridge
  ansible.builtin.user:
    name: matterbridge
    home: /etc/matterbridge
    shell: /sbin/nologin
    system: true
    state: present

- name: Création du dossier d'installation de Matterbridge
  ansible.builtin.file:
    path: /opt/matterbridge
    owner: root
    group: root
    mode: "u=rwx,go=rx"
    state: directory

- name: Téléchargement du binaire Matterbridge v{{ matterbridge_version }}
  ansible.builtin.get_url:
    url: https://github.com/42wim/matterbridge/releases/download/v{{ matterbridge_version }}/matterbridge-{{ matterbridge_version }}-linux-64bit
    dest: /opt/matterbridge/{{ matterbridge_version }}
    owner: root
    group: root
    mode: "u=rwx,go=rx"
    checksum: "sha256:https://github.com/42wim/matterbridge/releases/download/v{{ matterbridge_version }}/checksums.txt"

- name: Création du lien symbolique pour le binaire matterbridge
  ansible.builtin.file:
    src: /opt/matterbridge/{{ matterbridge_version }}
    dest: /usr/local/bin/matterbridge
    state: link
    owner: root
    group: root
    mode: "u=rwx,go=rx"
  notify: Restart matterbridge

- name: Création du dossier de configuration de Matterbridge
  ansible.builtin.file:
    path: /etc/matterbridge
    state: directory
    owner: matterbridge
    group: matterbridge
    mode: "u=rwx,g=rx,o="

- name: Configuration de Matterbridge
  ansible.builtin.template:
    src: matterbridge/config.toml.j2
    dest: /etc/matterbridge/config.toml
    owner: matterbridge
    group: matterbridge
    mode: "u=rw,g=r,o="
  notify: Restart matterbridge

- name: Configuration du service systemd
  ansible.builtin.template:
    src: systemd/matterbridge.service.j2
    dest: /etc/systemd/system/matterbridge.service
    owner: root
    group: root
    mode: "u=rw,go=r"
  notify:
    - Restart matterbridge

- name: Activation de Matterbridge au démarrage
  ansible.builtin.service:
    name: matterbridge
    state: started
    enabled: true

- name: Récupération de la liste des binaires
  ansible.builtin.find:
    path: /opt/matterbridge
    file_type: file
    use_regex: true
    recurse: false
    pattern: '^[0-9]+\.[0-9]+\.[0-9]+$'
  register: _matterbridge_binaries

- name: Suppression des anciens binaires
  ansible.builtin.file:
    path: "{{ binary.path }}"
    state: absent
  loop: "{{ _matterbridge_binaries.files }}"
  loop_control:
    loop_var: binary
    label: "{{ binary.path }}"
  when: matterbridge_old_version != matterbridge_version
  vars:
    matterbridge_old_version: "{{ binary.path | replace('/opt/matterbridge/', '') }}"

- name: Configuration des backups Borgmatic
  ansible.builtin.template:
    src: borgmatic/matterbridge.yml.j2
    dest: /etc/borgmatic.d/matterbridge.yml
    owner: root
    group: root
    mode: "u=rw,go="
    validate: borgmatic config validate --show -c %s
  tags: ['borgmatic_config']
