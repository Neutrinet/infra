---

- name: Test si le certificat {{ domain }} ecdsa existe
  ansible.builtin.stat:
    path: /etc/letsencrypt/live/{{ domain | replace('.', '-') }}-ecdsa/cert.pem
  register: letsencrypt_domain_ecdsa

- name: Cr√©ation du certificat {{ domain }} ecdsa  # noqa command-instead-of-shell no-changed-when
  ansible.builtin.shell:
    cmd: |
      /opt/letsencrypt/bin/certbot certonly \
      --non-interactive \
      {% if letsencrypt_staging %}--staging \{% endif %}
      {% if letsencrypt_post_hook != "" %}--post-hook '{{ letsencrypt_post_hook }}' \{% endif %}
      {% if letsencrypt_deploy_hook != "" %}--deploy-hook {{ letsencrypt_deploy_hook }} \{% endif %}
      --authenticator dns-gandi \
      --dns-gandi-credentials /etc/letsencrypt/gandi/gandi.ini \
      --key-type ecdsa \
      --cert-name {{ domain | replace('.', '-') }}-ecdsa \
      --domain {{ domain }} \
      --domain *\.{{ domain }}
  when: not letsencrypt_domain_ecdsa.stat.exists
