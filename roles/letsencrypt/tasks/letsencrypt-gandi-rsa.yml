---

- name: Test si le certificat {{ domain }} rsa existe
  ansible.builtin.stat:
    path: /etc/letsencrypt/live/{{ domain | replace('.', '-') }}/cert.pem
  register: letsencrypt_domain_rsa

- name: CrÃ©ation du certificat {{ domain }} rsa  # noqa command-instead-of-shell
  ansible.builtin.shell:
    cmd: |
      /opt/letsencrypt/bin/certbot certonly \
      --non-interactive \
      {% if letsencrypt_staging %}--staging \{% endif %}
      {% if letsencrypt_post_hook and letsencrypt_post_hook | length > 0 %}--post-hook '{{ letsencrypt_post_hook }}' \{% endif %}
      {% if letsencrypt_deploy_hook and letsencrypt_deploy_hook | length > 0 %}--deploy-hook {{ letsencrypt_deploy_hook }} \{% endif %}
      --authenticator dns-gandi \
      --dns-gandi-credentials /etc/letsencrypt/gandi/gandi.ini \
      --key-type rsa \
      --rsa-key-size 4096 \
      --cert-name {{ domain | replace('.', '-') }} \
      --domain {{ domain }} \
      --domain *\.{{ domain }}
  when: not letsencrypt_domain_rsa.stat.exists
