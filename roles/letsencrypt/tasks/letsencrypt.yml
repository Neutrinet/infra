---

- name: Installation des dépendances python
  ansible.builtin.package:
    name:
      - python3-dev
      - python3-venv
    state: present

- name: Création des dossiers Let's Encrypt
  ansible.builtin.file:
    path: "{{ item }}"
    owner: root
    group: root
    mode: "u=rwx,go=rx"
    state: directory
  with_items:
    - /etc/letsencrypt
    - /etc/letsencrypt/ovh
    - /opt/letsencrypt

- name: Vérifier si la version Python de venv correspond au système actuel
  ansible.builtin.stat:
    path: "/opt/letsencrypt/lib/python{{ ansible_python.version.major }}.{{ ansible_python.version.minor }}"
  register: python_version_match

- name: Supprimer l'environnement virtuel incompatible
  ansible.builtin.file:
    path: "/opt/letsencrypt"
    state: absent
  when:
    - not python_version_match.stat.exists

- name: Installation de certbot
  ansible.builtin.pip:
    name: certbot
    virtualenv: /opt/letsencrypt
    virtualenv_python: python3
    state: present
    version: "{{ letsencrypt_certbot_version }}"
    chdir: /opt/letsencrypt

- name: Installation de certbot-dns-ovh
  ansible.builtin.pip:
    name: certbot-dns-ovh
    virtualenv: /opt/letsencrypt
    virtualenv_python: python3
    state: present
    version: "{{ letsencrypt_certbot_version }}"
    chdir: /opt/letsencrypt

- name: Création d'un lien symbolique pour le binaire certbot
  ansible.builtin.file:
    src: /opt/letsencrypt/bin/certbot
    dest: /usr/local/bin/certbot
    state: link

- name: Création d'un cron job pour renouveler les certificats
  ansible.builtin.cron:
    name: "letsencrypt-update"
    cron_file: letsencrypt-update
    special_time: daily
    user: "root"
    job: "/opt/letsencrypt/bin/certbot renew"

- name: Enregistrement du compte Let's Encrypt
  ansible.builtin.command:
    cmd: >
      /opt/letsencrypt/bin/certbot register
      --non-interactive
      {% if letsencrypt_staging %}--staging {% endif %}
      --email {{ letsencrypt_mail_notification }}
      --no-eff-email
      --agree-tos
    creates: /etc/letsencrypt/accounts

- name: Config d'OVH pour Let's Encrypt
  ansible.builtin.template:
    dest: /etc/letsencrypt/ovh/ovh.ini
    src: ovh.ini.j2
    owner: root
    group: root
    mode: "u=rw,go="
  no_log: true
  when: letsencrypt_domains_ovh | length > 0

- name: Placement du hook pour HAproxy
  ansible.builtin.copy:
    src: haproxy.py
    dest: /etc/letsencrypt/haproxy.py
    mode: "ugo=rx"
    owner: root
    group: root

- name: Création des certificats rsa par challenge ovh
  ansible.builtin.include_tasks: letsencrypt-ovh-rsa.yml
  loop: "{{ letsencrypt_domains_ovh }}"
  loop_control:
    loop_var: domain

- name: Création des certificats ecdsa par challenge ovh
  ansible.builtin.include_tasks: letsencrypt-ovh-ecdsa.yml
  loop: "{{ letsencrypt_domains_ovh }}"
  loop_control:
    loop_var: domain
