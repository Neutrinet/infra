---

- name: Définition du nom du certificat {{ algorithm | upper }} {{ domain.name }}
  set_fact:
    cert_name: "{{ domain.name | replace('.', '-') }}-{{ algorithm }}"

- name: Test si le certificat {{ algorithm | upper }} {{ domain.name }} existe
  stat:
    path: /etc/letsencrypt/live/{{ cert_name }}/cert.pem
  register: letsencrypt_domain

- name: Création du certificat {{ algorithm | upper }} {{ domain.name }}
  command: >
    /opt/letsencrypt/bin/certbot certonly
      --non-interactive
    {% if letsencrypt_staging %}
      --staging
    {% endif %}
      --authenticator dns-gandi
      --dns-gandi-credentials /etc/letsencrypt/gandi/gandi.ini
      --key-type {{ algorithm }}
    {% if algorithm == 'rsa' %}
      --rsa-key-size 4096
    {% endif %}
      --cert-name {{ cert_name }}
      --domain {{ domain.name }}
      --domain *\.{{ domain.name }}
    {% for hook in domain.hooks.deploy | default([]) %}
      --deploy-hook {{ hook | quote }}

    {% endfor %}
    {% for hook in domain.hooks.post | default([]) %}
      --post-hook {{ hook | quote }}

    {% endfor %}
  when: not letsencrypt_domain.stat.exists
