---
- name: Ajout de la clé GPG de Caddy dans APT
  ansible.builtin.get_url:
    url: https://dl.cloudsmith.io/public/caddy/stable/gpg.155B6D79CA56EA34.key
    dest: /etc/apt/keyrings/caddy.asc
    owner: root
    group: root
    mode: "ugo=r"
    force: true

- name: Ajout du dépôt APT pour Caddy
  ansible.builtin.apt_repository:
    repo: deb [signed-by=/etc/apt/keyrings/caddy.asc] https://dl.cloudsmith.io/public/caddy/stable/deb/{{ ansible_distribution | lower }} any-version main
    filename: caddy-stable
    state: present

- name: Installation de Caddy
  ansible.builtin.package:
    name: caddy
    state: present

- name: Création du dossier de config des VHosts
  ansible.builtin.file:
    path: "{{ caddy_vhosts_dir }}"
    state: directory
    owner: root
    group: root
    mode: "u=rwx,go=rx"

- name: Copie du fichier de config principal
  ansible.builtin.template:
    src: caddy/Caddyfile.j2
    dest: "{{ caddy_config_dir }}/Caddyfile"
    owner: root
    group: root
    mode: "u=rw,go=r"
    validate: caddy validate --adapter caddyfile --config %s
  notify: Reload caddy

- name: Copie de la config du healthcheck
  ansible.builtin.template:
    src: caddy/healthcheck.j2
    dest: "{{ caddy_vhosts_dir }}/healthcheck.conf"
    owner: root
    group: root
    mode: "u=rw,go=r"
    validate: caddy validate --adapter caddyfile --config %s
  notify: Reload caddy

- name: Création du dossier des logs
  ansible.builtin.file:
    path: "{{ caddy_log_dir }}"
    state: directory
    owner: caddy
    group: caddy
    mode: "u=rwx,g=rx,o="

- name: Activation du service caddy au démarage
  ansible.builtin.service:
    name: caddy
    state: started
    enabled: true

- name: Trigger Caddy handlers
  ansible.builtin.meta: flush_handlers
