---
- name: Converge
  hosts: all
  become: true

  pre_tasks:
    - name: Mise Ã  jour du cache APT
      ansible.builtin.apt:
        update_cache: true

  roles:
    - caddy_server

  post_tasks:
    - name: Copie de la config d'exemple de Caddy
      ansible.builtin.copy:
        content: |
          localhost {
            root * /etc/caddy
            file_server browse
            tls internal # self-signed certs

            log {
              output file /var/log/caddy/example.log
            }
          }
        dest: /etc/caddy/conf.d/example.conf
        owner: root
        group: root
        mode: "u=rw,go=r"
        validate: caddy validate --adapter caddyfile --config %s
      notify: Reload caddy
