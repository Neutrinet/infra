---
- name: Installation de Keepalived
  package:
    name: keepalived
    state: present

- name: Configuration de Keepalived
  template:
    src: keepalived.conf.j2
    dest: /etc/keepalived/keepalived.conf
    owner: root
    group: root
    mode: "u=rw,g=r,o="
    validate: keepalived -t -f %s
  notify: reload keepalived

- name: Autorisation écoute sur l'ip VIP
  ansible.posix.sysctl:
    name: "net.{{ item }}.ip_nonlocal_bind"
    value: '1'
    sysctl_file: /etc/sysctl.d/80-ip-nonlocal-bind.conf
    sysctl_set: true
    state: present
    reload: true
  loop:
    - ipv4
    - ipv6

- name: Activation de Keepalived au démarrage
  service:
    name: keepalived
    state: started
    enabled: true
