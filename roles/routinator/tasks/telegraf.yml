# cela peut prendre maximum 20 minutes
- name: Attendre que routinator soit operationel
  ansible.builtin.uri:
    url: "http://localhost:8323/metrics"
    status_code: 200
  register: result
  until: result.status == 200
  retries: 40
  delay: 30
  tags: ['telegraf_config']

- name: Installation des plugins Telegraf
  ansible.builtin.template:
    src: telegraf/routinator.conf.j2
    dest: /etc/telegraf/telegraf.d/routinator.conf
    owner: telegraf
    group: telegraf
    mode: "ug=r,o="
    validate: telegraf --config %s --test
  notify: Restart telegraf
  tags: ['telegraf_config']
