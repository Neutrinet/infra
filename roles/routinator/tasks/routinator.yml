---
- name: Installation des ACL
  ansible.builtin.package:
    name: acl
    state: present
  tags: ['routinator_install']

- name: Ajout de la clé GPG de NLnet Labs
  ansible.builtin.get_url:
    url: https://packages.nlnetlabs.nl/aptkey.asc
    dest: /etc/apt/keyrings/routinator.asc
    owner: root
    group: root
    mode: "ugo=r"
    force: true
  tags: ['routinator_install']

- name: Ajout du dépôt APT pour routinator
  ansible.builtin.apt_repository:
    repo: deb [signed-by=/etc/apt/keyrings/routinator.asc] https://packages.nlnetlabs.nl/linux/debian {{ ansible_distribution_release }} main
    state: present
    filename: routinator
  tags: ['routinator_install']

- name: Installation de routinator
  ansible.builtin.package:
    name: routinator
    state: present
  tags: ['routinator_install']

- name: Configuration de routinator
  ansible.builtin.template:
    src: routinator.conf.j2
    dest: /etc/routinator/routinator.conf
    owner: routinator
    group: routinator
    mode: "ug=r,o="
    validate: routinator --config %s config
  notify: Restart routinator
  tags: ['routinator_config']

- name: Ajout exception Neutrinet pour routinator
  ansible.builtin.copy:
    src: exceptions.json
    dest: /etc/routinator/exceptions.json
    owner: routinator
    group: routinator
    mode: "ug=r,o="
  notify: Restart routinator
  tags: ['routinator_config']

- name: Initialisation de routinator
  ansible.builtin.command:
    cmd: /usr/bin/routinator --config /etc/routinator/routinator.conf init --accept-arin-rpa
    creates: /var/lib/routinator/rpki-cache
    chdir: /var/lib/routinator
  become: true
  become_user: routinator
  tags: ['routinator_config']

- name: Activation du service routinator au démarage
  ansible.builtin.service:
    name: routinator
    state: started
    enabled: true
  tags: ['routinator_config']
