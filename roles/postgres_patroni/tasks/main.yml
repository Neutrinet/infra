---
- name: Installation de PostgreSQL
  ansible.builtin.import_role:
    name: postgres
  tags: ['postgresql']

- name: Désactivation du serveur PostgreSQL par défaut
  ansible.builtin.service:
    name: postgresql
    state: stopped
    enabled: false
  tags: ['postgresql']

- name: Installation de Etcd
  ansible.builtin.import_role:
    name: etcd
  tags: ['etcd']

- name: Installation de Patroni
  ansible.builtin.package:
    name: patroni
    state: present

- name: Configuration de Patroni
  ansible.builtin.template:
    src: config.yml.j2
    dest: /etc/patroni/config.yml
    owner: postgres
    group: postgres
    mode: "u=rw,g=r,o="
    validate: patroni --validate-config %s
  vars:
    patroni_current_member: "{{ etcd_members | selectattr('name', '==', ansible_hostname) | first }}"
  notify: Reload patroni

- name: Activation de Patroni au démarrage
  ansible.builtin.service:
    name: patroni
    state: started
    enabled: true

- name: Vérification que le cluster Patroni est prêt
  ansible.builtin.uri:
    url: http://localhost:8008/health
  register: _postgresql_patroni_health
  retries: 10
  delay: 3
  until: _postgresql_patroni_health is success

- name: Installation de PostgreSQL exporter
  ansible.builtin.include_role:
    name: postgres_exporter
  vars:
    postgres_role: "{{ _postgresql_patroni_health.json.role }}"
  tags: ['postgres_exporter']

# - name: Suppression de l'utilisateur PostgreSQL telegraf
#   community.postgresql.postgresql_user:
#     name: telegraf
#     state: absent
#   become: true
#   become_user: postgres
#   when: _postgresql_patroni_health.json.role == 'master'
#   tags: ['telegraf_config']

- name: Configuration de vector
  ansible.builtin.template:
    src: vector/prometheus_patroni_exporter.yaml.j2
    dest: /etc/vector/sources/prometheus_patroni_exporter.yaml
    owner: vector
    group: vector
    mode: "ug=r,o="
  notify: Restart vector
  tags: ['vector_config']

- name: Configuration des backups Borgmatic
  ansible.builtin.template:
    src: borgmatic/patroni.yml.j2
    dest: /etc/borgmatic.d/patroni.yml
    owner: root
    group: root
    mode: "u=rw,go="
    validate: borgmatic config validate --show -c %s
  tags: ['borgmatic_config']
