- name: Installation des dépendences
  ansible.builtin.package:
    name: python-is-python3
    state: present

- name: Récupération du dépôt git de nagios-scinga-openvpn
  ansible.builtin.git:
    repo: https://github.com/liquidat/nagios-icinga-openvpn
    version: master
    dest: /opt/nagios-icinga-openvpn
    single_branch: true
    update: true

- name: Création du lien symbolique pour le binaire check_openvpn
  ansible.builtin.file:
    src: /opt/nagios-icinga-openvpn/bin/check_openvpn
    dest: /usr/local/bin/check_openvpn
    mode: "u=rwx,go=rx"
    state: link

- name: Copie du wrapper pour check_openvpn
  ansible.builtin.copy:
    src: check_openvpn.sh
    dest: /opt/check_openvpn.sh
    owner: root
    group: root
    mode: "u=rwx,go=rx"

- name: Configuration de vector
  ansible.builtin.template:
    src: vector/prometheus_nagios_openvpn.yaml.j2
    dest: /etc/vector/sources/prometheus_check_openvpn_{{ protocol }}_{{ probe.port }}_ipv{{ ip_version }}.yaml
    owner: vector
    group: vector
    mode: "ug=r,o="
  loop: "{{ nagios_openvpn_probes }}"
  loop_control:
    loop_var: probe
    label: "{{ protocol }}://{{ probe.address }}:{{ probe.port }}"
  vars:
    protocol: "{{ 'tcp' if probe.tcp else 'udp' }}"
    ip_version: "{{ 6 if ':' in probe.address else 4 }}"
  notify: Restart vector
  tags: ['vector_config']
